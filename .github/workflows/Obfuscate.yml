name: Build and Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip

      - name: ä¸‹è½½å®Œæ•´ BPB é¢æ¿ï¼ˆå¤šæºå®¹é”™ï¼‰
        run: |
          echo "å¼€å§‹ä¸‹è½½å®Œæ•´çš„ BPB é¢æ¿..."
          
          # å°è¯•ä¸‹è½½å®Œæ•´çš„é¢æ¿ä»£ç 
          REPO_URLS=(
            "https://github.com/bia-pain-bache/BPB-Worker-Panel/archive/refs/heads/main.zip"
            "https://codeload.github.com/bia-pain-bache/BPB-Worker-Panel/zip/refs/heads/main"
          )
          
          success=0
          for url in "${REPO_URLS[@]}"; do
            echo "å°è¯•ä¸‹è½½å®Œæ•´é¢æ¿: $url"
            if curl -L --connect-timeout 30 --max-time 60 "$url" -o panel.zip; then
              echo "âœ… ä¸‹è½½æˆåŠŸï¼Œè§£å‹é¢æ¿..."
              unzip -q panel.zip -d bpb-panel/
              if [ -d "bpb-panel/BPB-Worker-Panel-main" ]; then
                mv bpb-panel/BPB-Worker-Panel-main/* .
                success=1
                break
              elif [ -d "bpb-panel" ]; then
                mv bpb-panel/* .
                success=1
                break
              fi
            else
              echo "âŒ ä¸‹è½½å¤±è´¥: $url"
            fi
          done
          
          # å¦‚æœå®Œæ•´é¢æ¿ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•ç‹¬ä¸‹è½½ worker.js å¤‡ç”¨
          if [ "$success" -ne 1 ]; then
            echo "å®Œæ•´é¢æ¿ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•ç‹¬ä¸‹è½½ worker.js..."
            WORKER_URLS=(
              "https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/v4.0.1/worker.js"
              "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
            )
            
            for url in "${WORKER_URLS[@]}"; do
              echo "å°è¯•ä¸‹è½½ worker.js: $url"
              if curl -L --connect-timeout 20 "$url" -o worker.js; then
                echo "âœ… worker.js ä¸‹è½½æˆåŠŸ"
                
                # åˆ›å»ºåŸºæœ¬çš„ index.html
                cat > index.html << 'EOF'
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>BPB Worker Panel</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 40px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                        }
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: rgba(255, 255, 255, 0.1);
                            padding: 30px;
                            border-radius: 10px;
                            backdrop-filter: blur(10px);
                        }
                        h1 {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .status {
                            background: rgba(255, 255, 255, 0.2);
                            padding: 15px;
                            border-radius: 5px;
                            margin: 20px 0;
                        }
                        .success {
                            color: #4CAF50;
                        }
                        .error {
                            color: #f44336;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>ğŸš€ BPB Worker Panel</h1>
                        <div class="status">
                            <p>é¢æ¿æ­£åœ¨è¿è¡Œ...</p>
                            <p>è¯·ç¡®ä¿ worker.js å·²æ­£ç¡®é…ç½®ã€‚</p>
                        </div>
                        <p>å¦‚æœéœ€è¦å®Œæ•´ UIï¼Œè¯·æ£€æŸ¥æ˜¯å¦ä¸‹è½½äº†å®Œæ•´çš„é¢æ¿æ–‡ä»¶ã€‚</p>
                    </div>
                </body>
                </html>
                EOF
                
                echo "âœ… å·²åˆ›å»ºåŸºç¡€ HTML ç•Œé¢"
                success=2
                break
              else
                echo "âŒ worker.js ä¸‹è½½å¤±è´¥: $url"
              fi
            done
          fi
          
          if [ "$success" -eq 0 ]; then
            echo "âŒ æ‰€æœ‰ä¸‹è½½æºéƒ½å¤±è´¥ï¼Œæµç¨‹ç»ˆæ­¢"
            exit 1
          fi

      - name: æ£€æŸ¥é¢æ¿ç»“æ„
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          
          echo "ğŸ“„ æ£€æŸ¥å…³é”®æ–‡ä»¶:"
          [ -f "index.html" ] && echo "âœ… index.html å­˜åœ¨" || echo "âŒ ç¼ºå°‘ index.html"
          [ -f "worker.js" ] && echo "âœ… worker.js å­˜åœ¨" || echo "âŒ ç¼ºå°‘ worker.js"
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°:"
          [ -f "index.html" ] && echo "index.html: $(wc -l < index.html) è¡Œ"
          [ -f "worker.js" ] && echo "worker.js: $(wc -c < worker.js) å­—èŠ‚"

      - name: åº”ç”¨æ™ºèƒ½è¡¥ä¸ï¼ˆä¸ç ´ååŸæœ‰é€»è¾‘ï¼‰
        run: |
          echo "åº”ç”¨æ™ºèƒ½è¡¥ä¸..."
          
          # å¤‡ä»½åŸå§‹æ–‡ä»¶
          [ -f "worker.js" ] && cp worker.js worker.js.backup
          
          # ä½¿ç”¨æ›´ç²¾ç¡®çš„ sed å‘½ä»¤
          if [ -f "worker.js" ]; then
            echo "åº”ç”¨ 80 ç«¯å£å…¼å®¹è¡¥ä¸..."
            # åªæ›¿æ¢ç¡®åˆ‡çš„ 8000 æ•°å­—ï¼ˆé¿å…æ›¿æ¢å­—ç¬¦ä¸²ä¸­çš„ 8000ï¼‰
            sed -i 's/port:\s*8000/port: 80/g' worker.js
            sed -i 's/PORT\s*=\s*8000/PORT = 80/g' worker.js
            sed -i 's/:8000/:80/g' worker.js
            
            echo "åº”ç”¨æœ€å¤§èŠ‚ç‚¹é™åˆ¶è¡¥ä¸..."
            # æ›´æ™ºèƒ½çš„æ›¿æ¢ï¼Œé¿å…ç ´åå…¶ä»–ä»£ç 
            sed -i 's/MAX_NODE\s*=\s*[0-9]*/MAX_NODE = 5/g' worker.js
            sed -i 's/maxNodes\s*=\s*[0-9]*/maxNodes = 5/g' worker.js
            
            echo "âœ… è¡¥ä¸åº”ç”¨å®Œæˆ"
            
            # æ£€æŸ¥è¡¥ä¸æ˜¯å¦æˆåŠŸ
            echo "è¡¥ä¸éªŒè¯:"
            grep -n "port.*80" worker.js | head -5 && echo "âœ… 80 ç«¯å£è®¾ç½®æˆåŠŸ"
            grep -n "MAX_NODE.*5" worker.js && echo "âœ… æœ€å¤§èŠ‚ç‚¹é™åˆ¶æˆåŠŸ"
            grep -n "maxNodes.*5" worker.js && echo "âœ… æœ€å¤§èŠ‚ç‚¹é™åˆ¶æˆåŠŸ"
          else
            echo "âŒ worker.js ä¸å­˜åœ¨ï¼Œè·³è¿‡è¡¥ä¸"
          fi

      - name: å®‰è£… JS æ··æ·†å™¨
        run: |
          npm install -g javascript-obfuscator@4.1.0

      - name: æ··æ·† Worker.jsï¼ˆä¿ç•™å…³é”®åŠŸèƒ½ï¼‰
        run: |
          echo "å¼€å§‹æ··æ·† worker.js..."
          
          if [ -f "worker.js" ]; then
            # ä½¿ç”¨å®‰å…¨æ··æ·†é…ç½®ï¼Œé¿å…ç ´å UI ç›¸å…³åŠŸèƒ½
            javascript-obfuscator worker.js --output worker.obf.js \
              --compact true \
              --control-flow-flattening false \
              --dead-code-injection false \
              --identifier-names-generator hexadecimal \
              --rename-globals false \
              --self-defending true \
              --string-array true \
              --string-array-encoding 'base64' \
              --string-array-threshold 0.75 \
              --transform-object-keys true \
              --unicode-escape-sequence false
            
            echo "âœ… æ··æ·†å®Œæˆ"
            echo "åŸå§‹å¤§å°: $(wc -c < worker.js) å­—èŠ‚"
            echo "æ··æ·†åå¤§å°: $(wc -c < worker.obf.js) å­—èŠ‚"
            
            # éªŒè¯æ··æ·†æ–‡ä»¶
            if head -10 worker.obf.js | grep -q "function"; then
              echo "âœ… æ··æ·†æ–‡ä»¶åŒ…å«å‡½æ•°ï¼Œå¯èƒ½æœ‰æ•ˆ"
            else
              echo "âš ï¸  è­¦å‘Š: æ··æ·†æ–‡ä»¶å¯èƒ½æŸå"
            fi
          else
            echo "âŒ worker.js ä¸å­˜åœ¨ï¼Œè·³è¿‡æ··æ·†"
          fi

      - name: éƒ¨ç½²æ–‡ä»¶å‡†å¤‡
        run: |
          echo "å‡†å¤‡éƒ¨ç½²æ–‡ä»¶..."
          
          # ä½¿ç”¨æ··æ·†åçš„æ–‡ä»¶
          [ -f "worker.obf.js" ] && cp worker.obf.js worker.js
          
          # ç¡®ä¿å¿…è¦çš„æ–‡ä»¶å­˜åœ¨
          [ ! -f "index.html" ] && echo "<h1>BPB Panel</h1><p>Worker is running</p>" > index.html
          [ ! -f "README.md" ] && echo "# BPB Worker Panel\n\nè‡ªåŠ¨æ„å»ºçš„é¢æ¿" > README.md
          
          echo "ğŸ“¦ æœ€ç»ˆæ–‡ä»¶åˆ—è¡¨:"
          ls -la *.html *.js *.md 2>/dev/null || echo "æ— ç›¸å…³æ–‡ä»¶"

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° BPB é¢æ¿ $(date '+%Y-%m-%d %H:%M:%S')
            
            â€¢ æ›´æ–° worker.js
            â€¢ ä¼˜åŒ– UI ç•Œé¢
            â€¢ åº”ç”¨å®‰å…¨è¡¥ä¸
            â€¢ 80ç«¯å£å…¼å®¹
            â€¢ èŠ‚ç‚¹é™åˆ¶: 5"
            git push
            echo "âœ… æäº¤æˆåŠŸ"
          fi

      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆ!"
          echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
          echo "â€¢ ä¸»æ–‡ä»¶: index.html"
          echo "â€¢ Worker æ–‡ä»¶: worker.js"
          echo "â€¢ æ··æ·†æ–‡ä»¶: worker.obf.js"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€:"
          echo "https://[ä½ çš„ç”¨æˆ·å].github.io/[ä»“åº“å]/"
          echo ""
          echo "ğŸ“ æç¤º:"
          echo "1. ç¡®ä¿åœ¨ä»“åº“è®¾ç½®ä¸­å¯ç”¨ GitHub Pages"
          echo "2. é€‰æ‹© main åˆ†æ”¯ä½œä¸ºæº"
          echo "3. é€‰æ‹© / (æ ¹ç›®å½•) ä½œä¸ºæ–‡ä»¶å¤¹"
