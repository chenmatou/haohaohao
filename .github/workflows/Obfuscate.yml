name: Build and Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip

      - name: ä¸‹è½½å®Œæ•´ BPB é¢æ¿ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        run: |
          echo "å¼€å§‹ä¸‹è½½ BPB é¢æ¿..."
          
          # æ–¹æ³•1ï¼šç›´æ¥ä¸‹è½½ worker.jsï¼ˆä¸»è¦æ–‡ä»¶ï¼‰
          WORKER_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/v4.0.1/worker.js"
          
          echo "å°è¯•ä¸‹è½½ worker.js..."
          if curl -L --connect-timeout 30 --max-time 60 "$WORKER_URL" -o worker.js; then
            echo "âœ… worker.js ä¸‹è½½æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $(wc -c < worker.js) å­—èŠ‚"
            
            # åˆ›å»ºç®€åŒ–ç‰ˆçš„ index.html
            echo '<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPB Worker Panel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ BPB Worker Panel</h1>
        <div class="status">
            <p>é¢æ¿æ­£åœ¨è¿è¡Œ...</p>
            <p>Worker.js å·²æˆåŠŸåŠ è½½ã€‚</p>
        </div>
        <p>ç‰ˆæœ¬: v4.0.1</p>
        <p>ç«¯å£: 80</p>
        <p>æœ€å¤§èŠ‚ç‚¹æ•°: 5</p>
    </div>
</body>
</html>' > index.html
            
            echo "âœ… index.html åˆ›å»ºæˆåŠŸ"
            
          else
            echo "âŒ worker.js ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æº..."
            
            # æ–¹æ³•2ï¼šä¸‹è½½å®Œæ•´ä»“åº“
            REPO_URL="https://codeload.github.com/bia-pain-bache/BPB-Worker-Panel/zip/refs/heads/main"
            
            if curl -L "$REPO_URL" -o panel.zip; then
              echo "âœ… ä»“åº“ä¸‹è½½æˆåŠŸï¼Œè§£å‹..."
              unzip -q panel.zip -d ./
              if [ -d "BPB-Worker-Panel-main" ]; then
                cp -r BPB-Worker-Panel-main/* ./
                rm -rf BPB-Worker-Panel-main
              fi
              echo "âœ… ä»“åº“è§£å‹å®Œæˆ"
            else
              echo "âŒ æ‰€æœ‰ä¸‹è½½æºéƒ½å¤±è´¥ï¼Œæµç¨‹ç»ˆæ­¢"
              exit 1
            fi
          fi

      - name: æ£€æŸ¥é¢æ¿ç»“æ„
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          
          echo "ğŸ“„ æ£€æŸ¥å…³é”®æ–‡ä»¶:"
          [ -f "index.html" ] && echo "âœ… index.html å­˜åœ¨" || echo "âŒ ç¼ºå°‘ index.html"
          [ -f "worker.js" ] && echo "âœ… worker.js å­˜åœ¨" || echo "âŒ ç¼ºå°‘ worker.js"
          
          if [ -f "worker.js" ]; then
            echo "ğŸ“Š worker.js å¤§å°: $(wc -c < worker.js) å­—èŠ‚"
            echo "ğŸ“Š worker.js è¡Œæ•°: $(wc -l < worker.js) è¡Œ"
          fi

      - name: åº”ç”¨è¡¥ä¸
        run: |
          echo "åº”ç”¨è¡¥ä¸..."
          
          if [ -f "worker.js" ]; then
            # å¤‡ä»½åŸå§‹æ–‡ä»¶
            cp worker.js worker.js.backup
            
            # åº”ç”¨ 80 ç«¯å£è¡¥ä¸ï¼ˆåªæ›¿æ¢ç¡®åˆ‡çš„ç«¯å£å·ï¼‰
            echo "åº”ç”¨ 80 ç«¯å£å…¼å®¹è¡¥ä¸..."
            sed -i 's/:8000/:80/g' worker.js
            sed -i 's/port:\s*8000/port: 80/g' worker.js
            sed -i 's/PORT\s*=\s*8000/PORT = 80/g' worker.js
            
            # åº”ç”¨æœ€å¤§èŠ‚ç‚¹é™åˆ¶è¡¥ä¸
            echo "åº”ç”¨æœ€å¤§èŠ‚ç‚¹é™åˆ¶è¡¥ä¸..."
            sed -i 's/MAX_NODE\s*=\s*[0-9]*/MAX_NODE = 5/g' worker.js
            sed -i 's/maxNodes\s*=\s*[0-9]*/maxNodes = 5/g' worker.js
            sed -i 's/max_node\s*=\s*[0-9]*/max_node = 5/g' worker.js
            
            echo "âœ… è¡¥ä¸åº”ç”¨å®Œæˆ"
            
            # éªŒè¯è¡¥ä¸
            echo "è¡¥ä¸éªŒè¯:"
            echo "80ç«¯å£è®¾ç½®:"
            grep -n "80" worker.js | grep -E "(port|PORT)" | head -3 || echo "æœªæ‰¾åˆ°ç›¸å…³è®¾ç½®"
            echo "æœ€å¤§èŠ‚ç‚¹è®¾ç½®:"
            grep -n -i "max.*node.*5" worker.js | head -3 || echo "æœªæ‰¾åˆ°ç›¸å…³è®¾ç½®"
          else
            echo "âŒ worker.js ä¸å­˜åœ¨ï¼Œè·³è¿‡è¡¥ä¸"
          fi

      - name: å®‰è£… JS æ··æ·†å™¨
        run: |
          npm install -g javascript-obfuscator@4.0.0

      - name: æ··æ·† Worker.js
        run: |
          echo "å¼€å§‹æ··æ·†..."
          
          if [ -f "worker.js" ]; then
            # ä½¿ç”¨ç®€å•çš„æ··æ·†é…ç½®
            javascript-obfuscator worker.js --output worker.obf.js \
              --compact true \
              --identifier-names-generator hexadecimal \
              --rename-globals false \
              --string-array true \
              --string-array-encoding 'base64' \
              --string-array-threshold 0.75
            
            echo "âœ… æ··æ·†å®Œæˆ"
            echo "åŸå§‹å¤§å°: $(wc -c < worker.js) å­—èŠ‚"
            echo "æ··æ·†åå¤§å°: $(wc -c < worker.obf.js) å­—èŠ‚"
          else
            echo "âŒ worker.js ä¸å­˜åœ¨ï¼Œè·³è¿‡æ··æ·†"
          fi

      - name: éƒ¨ç½²å‡†å¤‡
        run: |
          echo "å‡†å¤‡éƒ¨ç½²..."
          
          # ä½¿ç”¨æ··æ·†åçš„æ–‡ä»¶æ›¿æ¢åŸæ–‡ä»¶
          if [ -f "worker.obf.js" ]; then
            cp worker.obf.js worker.js
            echo "âœ… ä½¿ç”¨æ··æ·†åçš„ worker.js"
          fi
          
          # ç¡®ä¿æ‰€æœ‰å¿…è¦æ–‡ä»¶å­˜åœ¨
          [ ! -f "index.html" ] && echo "<h1>BPB Panel</h1><p>Worker is running</p>" > index.html
          
          echo "ğŸ“¦ æœ€ç»ˆæ–‡ä»¶:"
          ls -la *.html *.js *.json 2>/dev/null || true

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° BPB é¢æ¿ $(date '+%Y-%m-%d %H:%M:%S')
            
            æ›´æ–°å†…å®¹:
            â€¢ æ›´æ–° worker.js åˆ°æœ€æ–°ç‰ˆæœ¬
            â€¢ åº”ç”¨ 80 ç«¯å£å…¼å®¹è¡¥ä¸
            â€¢ é™åˆ¶æœ€å¤§èŠ‚ç‚¹æ•°ä¸º 5
            â€¢ ä¼˜åŒ–æ··æ·†é…ç½®"
            
            # å°è¯•æ¨é€
            if git push; then
              echo "âœ… æäº¤æˆåŠŸ"
            else
              echo "âŒ æ¨é€å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€"
              git push --force
            fi
          fi

      - name: éªŒè¯ç»“æœ
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆ!"
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "â€¢ index.html: $([ -f "index.html" ] && wc -l < index.html || echo 0) è¡Œ"
          echo "â€¢ worker.js: $([ -f "worker.js" ] && wc -c < worker.js || echo 0) å­—èŠ‚"
          echo ""
          echo "ğŸ”§ å·²åº”ç”¨è¡¥ä¸:"
          echo "â€¢ 80ç«¯å£å…¼å®¹: âœ…"
          echo "â€¢ æœ€å¤§èŠ‚ç‚¹æ•°é™åˆ¶ä¸º 5: âœ…"
          echo "â€¢ ä»£ç æ··æ·†: âœ…"
          echo ""
          echo "ğŸš€ é¢æ¿å·²éƒ¨ç½²åˆ° GitHub Pages"
