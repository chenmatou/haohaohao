name: Build and Obfuscate BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Node.js 环境（固定单节点版本，保障长期稳定）
        uses: actions/setup-node@v4
        with:
          node-version: "20"   # 固定为当前最稳定原生 Node 主版本
          check-latest: false

      - name: 安装依赖项
        run: |
          # 锁定 obfuscator 版本，保证混淆结果长期稳定
          npm install -g javascript-obfuscator@4.1.0

      - name: 下载 BPB worker.js（使用指定 v4.0.1 地址 + 强稳定机制）
        run: |
          PRIMARY_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/v4.0.1/worker.js"

          FALLBACK_URLS=(
            "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
            "https://cdn.jsdelivr.net/gh/bia-pain-bache/BPB-Worker-Panel@main/build/unobfuscated-worker.js"
            "https://ghproxy.com/https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
          )

          echo "开始下载 BPB worker.js 文件..."

          download() {
            wget --dns-timeout=10 --connect-timeout=10 --read-timeout=20 \
                 --tries=3 --retry-connrefused --no-cache \
                 --header="Cache-Control: no-cache" \
                 -O origin.js "$1"
          }

          if download "$PRIMARY_URL"; then
            echo "✅ Releases URL 下载成功"
          else
            echo "❌ Releases 下载失败，尝试备用 URL..."
            SUCCESS=false
            for url in "${FALLBACK_URLS[@]}"; do
              echo "尝试: $url"
              if download "$url"; then
                echo "✅ 备用 URL 下载成功: $url"
                SUCCESS=true
                break
              fi
            done
            if [ "$SUCCESS" = false ] || [ ! -f origin.js ] || [ ! -s origin.js ]; then
              echo "❌ 所有下载源失败，任务中止"
              exit 1
            fi
          fi

          echo "下载完成: $(wc -c < origin.js) 字节"

      - name: 一阶段预混淆（结构扰动层）
        run: |
          echo "开始第一阶段预混淆..."

          javascript-obfuscator origin.js --output stage1.js \
            --compact false \
            --dead-code-injection true \
            --dead-code-injection-threshold 0.2 \
            --string-array true \
            --string-array-threshold 1 \
            --string-array-encoding none \
            --string-array-index-shift true \
            --identifier-names-generator hexadecimal \
            --unicode-escape-sequence false \
            --seed 9527

          echo "一阶段完成: $(wc -c < stage1.js) 字节"

      - name: 二阶段企业级深度混淆（主混淆层）
        run: |
          echo "开始第二阶段企业级混淆..."

          javascript-obfuscator stage1.js --output _worker.js \
            --compact true \
            --control-flow-flattening true \
            --control-flow-flattening-threshold 0.9 \
            --dead-code-injection false \
            --identifier-names-generator mangled \
            --rename-globals false \
            --string-array true \
            --string-array-encoding 'rc4' \
            --string-array-threshold 1 \
            --string-array-index-shift true \
            --transform-object-keys true \
            --numbers-to-expressions true \
            --unicode-escape-sequence true \
            --target 'node' \
            --seed 9527

          echo "二阶段完成，最终文件大小: $(wc -c < _worker.js) 字节"

      - name: 提交更改
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          branch: main
          commit_message: ':rocket: 企业级混淆 + BPB 最新构建自动更新'
          commit_author: 'github-actions[bot] <github-actions[bot]@users.noreply.github.com>'
          push_options: '--set-upstream'