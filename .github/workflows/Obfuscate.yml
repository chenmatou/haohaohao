name: Build and Deploy BPB Panel

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 1 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y curl wget unzip git

      - name: å…‹éš†å®Œæ•´ BPB é¢æ¿ä»“åº“
        run: |
          echo "æ­£åœ¨å…‹éš†å®Œæ•´ BPB é¢æ¿ä»“åº“..."
          
          # å°è¯•å…‹éš†å®Œæ•´ä»“åº“
          if git clone --depth 1 https://github.com/bia-pain-bache/BPB-Worker-Panel.git bpb-full; then
            echo "âœ… å®Œæ•´ä»“åº“å…‹éš†æˆåŠŸ"
            
            # è¿›å…¥ä»“åº“ç›®å½•
            cd bpb-full
            
            # åˆ‡æ¢åˆ°æ­£ç¡®ç‰ˆæœ¬
            git checkout v4.0.1 || echo "ç‰ˆæœ¬åˆ‡æ¢å¤±è´¥ï¼Œä½¿ç”¨æœ€æ–°ç‰ˆæœ¬"
            
            # æ£€æŸ¥æ–‡ä»¶ç»“æ„
            echo "ğŸ“ ä»“åº“ç»“æ„:"
            find . -type f -name "*.html" -o -name "*.js" -o -name "*.css" | head -20
            
            # å¦‚æœæœ‰buildç›®å½•ï¼Œä¼˜å…ˆä½¿ç”¨
            if [ -d "build" ]; then
              echo "âœ… å‘ç° build ç›®å½•ï¼Œå¤åˆ¶æ–‡ä»¶..."
              cp -r build/* ../ || true
              cp -r ./*.html ../ 2>/dev/null || true
              cp -r ./*.css ../ 2>/dev/null || true
              cp -r ./*.js ../ 2>/dev/null || true
            else
              echo "å¤åˆ¶æ‰€æœ‰æ–‡ä»¶..."
              cp -r ./* ../ 2>/dev/null || true
            fi
            
            cd ..
            rm -rf bpb-full
          else
            echo "âŒ å…‹éš†å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•..."
          fi

      - name: ä¸‹è½½å’Œå‡†å¤‡æ ¸å¿ƒæ–‡ä»¶
        run: |
          echo "å‡†å¤‡æ ¸å¿ƒæ–‡ä»¶..."
          
          # ç¡®ä¿æœ‰ worker.jsï¼ˆè¿™æ˜¯æ ¸å¿ƒæ–‡ä»¶ï¼‰
          WORKER_URL="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/v4.0.1/worker.js"
          
          if curl -L --connect-timeout 30 "$WORKER_URL" -o worker.js; then
            echo "âœ… worker.js ä¸‹è½½æˆåŠŸ"
          else
            echo "âŒ worker.js ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºåŸºæœ¬ç‰ˆæœ¬..."
            # åˆ›å»ºåŸºæœ¬çš„ worker.js
            cat > worker.js << 'EOF'
            // BPB Worker å ä½æ–‡ä»¶
            // è¿™æ˜¯ä¸€ä¸ªå ä½æ–‡ä»¶ï¼Œå®é™…åŠŸèƒ½éœ€è¦å®Œæ•´çš„BPBé¢æ¿
            console.log('BPB Worker å·²åŠ è½½ï¼Œä½†éœ€è¦å®Œæ•´çš„é¢æ¿æ–‡ä»¶');
            export default {
              async fetch(request, env, ctx) {
                return new Response('BPB Worker æ­£åœ¨è¿è¡Œï¼Œè¯·ç¡®ä¿åŠ è½½äº†å®Œæ•´çš„é¢æ¿æ–‡ä»¶', {
                  headers: { 'Content-Type': 'text/html;charset=utf-8' }
                });
              }
            };
            EOF
          fi
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ index.htmlï¼ˆä»ä»“åº“å…‹éš†çš„ï¼‰
          if [ ! -f "index.html" ] || [ ! -s "index.html" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ index.htmlï¼Œå°è¯•è·å–å®˜æ–¹ç‰ˆæœ¬..."
            
            # å°è¯•ä¸‹è½½å®˜æ–¹çš„ index.html
            if curl -L --connect-timeout 30 "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/index.html" -o index.html 2>/dev/null; then
              echo "âœ… å®˜æ–¹ index.html ä¸‹è½½æˆåŠŸ"
            else
              echo "âŒ å®˜æ–¹ index.html ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºåŸºæœ¬ç‰ˆæœ¬..."
              # åˆ›å»ºä¸€ä¸ªæŒ‡å‘å®˜æ–¹é¢æ¿çš„é‡å®šå‘é¡µé¢
              cat > index.html << 'EOF'
              <!DOCTYPE html>
              <html lang="zh-CN">
              <head>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <title>BPB Worker Panel - é‡å®šå‘</title>
                  <meta http-equiv="refresh" content="0; url=https://github.com/bia-pain-bache/BPB-Worker-Panel">
                  <style>
                      body {
                          font-family: Arial, sans-serif;
                          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                          color: white;
                          display: flex;
                          justify-content: center;
                          align-items: center;
                          height: 100vh;
                          margin: 0;
                      }
                      .container {
                          text-align: center;
                          padding: 40px;
                          background: rgba(255, 255, 255, 0.1);
                          border-radius: 15px;
                          backdrop-filter: blur(10px);
                          max-width: 600px;
                      }
                      h1 {
                          margin-bottom: 20px;
                      }
                      p {
                          margin: 10px 0;
                          line-height: 1.6;
                      }
                      a {
                          color: #4CAF50;
                          text-decoration: none;
                          font-weight: bold;
                      }
                  </style>
              </head>
              <body>
                  <div class="container">
                      <h1>ğŸš€ BPB Worker Panel v4.0.1</h1>
                      <p>æ­£åœ¨é‡å®šå‘åˆ°å®˜æ–¹é¢æ¿...</p>
                      <p>å¦‚æœæ‚¨çš„æµè§ˆå™¨æ²¡æœ‰è‡ªåŠ¨è·³è½¬ï¼Œè¯·ç‚¹å‡» <a href="https://github.com/bia-pain-bache/BPB-Worker-Panel">è¿™é‡Œ</a></p>
                      <p>æˆ–è€…æ‰‹åŠ¨è®¿é—®ï¼šhttps://github.com/bia-pain-bache/BPB-Worker-Panel</p>
                      <p>è¯·æ³¨æ„ï¼šå®Œæ•´çš„ BPB é¢æ¿éœ€è¦ä»å®˜æ–¹ä»“åº“è·å–æ‰€æœ‰æ–‡ä»¶ã€‚</p>
                  </div>
              </body>
              </html>
              EOF
            fi
          fi

      - name: æ£€æŸ¥æ–‡ä»¶ç»“æ„
        run: |
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          
          echo ""
          echo "ğŸ“„ æ–‡ä»¶ç±»å‹ç»Ÿè®¡:"
          echo "HTML æ–‡ä»¶: $(find . -maxdepth 1 -name '*.html' | wc -l) ä¸ª"
          echo "JS æ–‡ä»¶: $(find . -maxdepth 1 -name '*.js' | wc -l) ä¸ª"
          echo "CSS æ–‡ä»¶: $(find . -maxdepth 1 -name '*.css' | wc -l) ä¸ª"
          
          if [ -f "index.html" ]; then
            echo ""
            echo "ğŸ“Š index.html é¢„è§ˆ:"
            head -20 index.html | grep -E "(title|h1|div|body)" || true
          fi

      - name: åº”ç”¨å¿…è¦çš„é…ç½®è¡¥ä¸
        run: |
          echo "åº”ç”¨é…ç½®è¡¥ä¸..."
          
          # åº”ç”¨ç«¯å£è¡¥ä¸ï¼ˆå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼‰
          if [ -f "worker.js" ]; then
            sed -i 's/:8000/:80/g' worker.js 2>/dev/null || true
            sed -i 's/port:\s*8000/port: 80/g' worker.js 2>/dev/null || true
            echo "âœ… 80ç«¯å£é…ç½®å·²åº”ç”¨"
          fi
          
          # å°è¯•åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®æœ€å¤§èŠ‚ç‚¹æ•°
          if [ -f "worker.js" ]; then
            sed -i 's/MAX_NODE\s*=\s*[0-9]*/MAX_NODE = 5/g' worker.js 2>/dev/null || true
            sed -i 's/maxNodes\s*=\s*[0-9]*/maxNodes = 5/g' worker.js 2>/dev/null || true
            echo "âœ… æœ€å¤§èŠ‚ç‚¹æ•°é™åˆ¶ä¸º5"
          fi

      - name: åˆ›å»ºè¯´æ˜æ–‡ä»¶
        run: |
          echo "åˆ›å»ºè¯´æ˜æ–‡ä»¶..."
          
          cat > README.md << 'EOF'
          # BPB Worker Panel v4.0.1
          
          ## éƒ¨ç½²è¯´æ˜
          
          è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨éƒ¨ç½²çš„ BPB Worker Panel ç‰ˆæœ¬ã€‚
          
          ### ä¸»è¦åŠŸèƒ½
          
          - **VLESS - Trojan** ä¿¡æ¯ç®¡ç†
          - **Xray ç‰‡æ®µ** é…ç½®
          - **è·¯ç”±è§„åˆ™** è®¾ç½®
          - **èŠ‚ç‚¹ç®¡ç†**
          
          ### æ³¨æ„äº‹é¡¹
          
          1. ç¡®ä¿æ‚¨å·²ç»æ­£ç¡®é…ç½®äº† Cloudflare Worker
          2. ç«¯å£é»˜è®¤è®¾ç½®ä¸º 80
          3. æœ€å¤§èŠ‚ç‚¹æ•°é™åˆ¶ä¸º 5
          4. å¦‚æœéœ€è¦å®Œæ•´åŠŸèƒ½ï¼Œè¯·ç¡®ä¿æ‰€æœ‰é¢æ¿æ–‡ä»¶éƒ½å·²æ­£ç¡®éƒ¨ç½²
          
          ### æ–‡ä»¶è¯´æ˜
          
          - `index.html`: ä¸»é¢æ¿ç•Œé¢
          - `worker.js`: Worker æ ¸å¿ƒé€»è¾‘
          - å…¶ä»–æ–‡ä»¶: é¢æ¿æ‰€éœ€çš„é™æ€èµ„æº
          
          ### æ›´æ–°
          
          æ­¤é¢æ¿ä¼šè‡ªåŠ¨ä»å®˜æ–¹ä»“åº“åŒæ­¥æ›´æ–°ã€‚
          
          GitHub Actions æ¯å¤©è‡ªåŠ¨è¿è¡Œï¼Œç¡®ä¿æ‚¨æ€»æ˜¯ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚
          EOF
          
          echo "âœ… README.md å·²åˆ›å»º"

      - name: æäº¤æ›´æ”¹
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "ğŸš€ è‡ªåŠ¨éƒ¨ç½² BPB Worker Panel v4.0.1 - $(date '+%Y-%m-%d %H:%M:%S')"
            
            # å°è¯•æ¨é€
            if git push; then
              echo "âœ… æäº¤æˆåŠŸ"
            else
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰å˜æ›´æˆ–æƒé™é—®é¢˜"
            fi
          fi

      - name: éªŒè¯éƒ¨ç½²
        run: |
          echo "ğŸ‰ BPB é¢æ¿éƒ¨ç½²æµç¨‹å®Œæˆ!"
          echo ""
          echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
          echo "â€¢ å·²éƒ¨ç½²æ–‡ä»¶: $(ls -la | wc -l) ä¸ª"
          echo "â€¢ æ ¸å¿ƒæ–‡ä»¶: worker.js"
          echo "â€¢ ä¸»ç•Œé¢: index.html"
          echo ""
          echo "ğŸ”— è®¿é—®åœ°å€:"
          echo "https://[æ‚¨çš„ç”¨æˆ·å].github.io/[ä»“åº“å]/"
          echo ""
          echo "âš ï¸  é‡è¦æç¤º:"
          echo "1. ç¡®ä¿åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­å¯ç”¨ GitHub Pages"
          echo "2. å¦‚æœé¢æ¿ä¸å®Œæ•´ï¼Œè¯·è®¿é—®å®˜æ–¹ä»“åº“è·å–å®Œæ•´æ–‡ä»¶:"
          echo "   https://github.com/bia-pain-bache/BPB-Worker-Panel"
          echo ""
          echo "âœ… æµç¨‹ç»“æŸ"
